<?xml version="1.0"?>

<!--
pmd.xml

This is a Maven Callback Build File.  It will
build the Parser again, if needed.  As well, it
will update documents on the Build Site.

-->

<project name="pmd" default="pre-build">
  <target name="load-tasks">
    <taskdef 
       name="dvsl"
       classname="org.apache.tools.dvsl.DVSLTask">
       <classpath refid="maven-classpath" />
    </taskdef>

    <taskdef
       name="pmd"
       classname="net.sourceforge.pmd.ant.PMDTask">
       <classpath>
         <pathelement location="${lib.repo}/pmd-0.6.jar" />
       </classpath>
    </taskdef>

<!--
    <taskdef
       name="quilt"
       classname="junit.quilt.ant.AntQuiltRunner">
      <classpath>
        <pathelement location="lib/quilt.jar" />
        <pathelement location="lib/bcel.jar" />
        <pathelement location="lib/commons-graph.jar" />
        <pathelement location="lib/commons-collections.jar" />
        <pathelement location="lib/colt.jar" />
      </classpath>
    </taskdef>
-->

  </target>

  <target name="pre-build"
          depends="JavaCC" />

  <target name="checkJJTree">
    <uptodate property="jjTree.notRequired"
              srcfile="etc/Java1.4-c.jjt"
              targetfile="src/net/sourceforge/pmd/ast/Java1.4-c.jj" />
  </target>

  <target name="jjTree" 
          depends="checkJJTree"
          unless="jjTree.notRequired">
    <fail message="javacc.home must be set."
          unless="javacc.home" />

    <jjtree target="etc/Java1.4-c.jjt"
            outputdirectory="src/net/sourceforge/pmd/ast/"
            javacchome="${javacc.home}" />
  </target>  

  <target name="checkJavaCC"
          depends="jjTree">
    <uptodate property="javaCC.notRequired"
              srcfile="src/net/sourceforge/pmd/ast/Java1.4-c.jj"
              targetfile="src/net/sourceforge/pmd/ast/JavaParser.java" />   
  </target>

  <target name="JavaCC" 
          depends="checkJavaCC" 
          unless="javaCC.notRequired">
    <fail message="javacc.home must be set."
          unless="javacc.home" />

    <javacc target="src/net/sourceforge/pmd/ast/Java1.4-c.jj"
            outputdirectory="src/net/sourceforge/pmd/ast/"
            javacchome="${javacc.home}" />
  </target>  

<!-- Documentation Chores -->
  <target name="pre-docs" depends="rule-docs,run-pmd,run-jdk,pmd-docs" />
  <target name="post-docs" depends="move-php" />

  <target name="rule-docs" depends="load-tasks">
    <mkdir dir="${maven.gen.docs}/rules" />
    <dvsl basedir="rulesets"
          destdir="${maven.gen.docs}/rules"
          extension=".xml"
          includes="*.xml"
          style="dvsl/rule-format.dvsl">
    </dvsl>
  </target>

  <target name="move-php">
    <move todir="${pmd.cgi.dest}">
      <fileset dir="${pmd.cgi.dest}" />
      <mapper type="glob" from="*.html" to="*.php" />
    </move>
  </target>

  <target name="quilt" depends="load-tasks">
    <mkdir dir="${maven.quilt.reportsDirectory}" />
    <quilt report="${maven.quilt.reportsDirectory}/coverage.xml"
           register="junit.quilt.cover.ball94.B94Registry"
           reporter="junit.quilt.reports.XMLSummary"
           packages="${maven.package}">
      <classpath>
        <path refid="maven.dependency.classpath" />
        <pathelement location="${maven.build.dest}" />
        <pathelement location="${maven.test.dest}" />
      </classpath>
      <fileset dir="${maven.unitTestSourceDirectory}">
        <patternset refid="maven.unit.test.set" />
      </fileset>
    </quilt>
  </target>

  <target name="quilt-docs" />

  <target name="run-pmd" depends="load-tasks">
    <mkdir dir="${maven.pmd.reportsDirectory}" />
    <pmd reportFile="${maven.pmd.reportsDirectory}/${maven.final.name}.xml"
         verbose="false"
         rulesetfiles="rulesets/basic.xml,rulesets/unusedcode.xml,rulesets/design.xml"
         format="xml"
         failonerror="no">
      <fileset dir="${maven.src.dir}">
        <include name="**/*.java" />
      </fileset>
    </pmd>
  </target>

  <target name="run-jdk" 
          depends="load-tasks"
          if="jdk14.src">
    <mkdir dir="${maven.pmd.reportsDirectory}" />
    <pmd reportFile="${maven.pmd.reportsDirectory}/jdk-1.4.xml"
         verbose="false"
         rulesetfiles="rulesets/basic.xml,rulesets/unusedcode.xml,rulesets/design.xml"
         format="xml"
         failonerror="no">
      <fileset dir="${jdk14.src}">
        <include name="**/*.java" />
      </fileset>
    </pmd>
  </target>

  <target name="pmd-docs" depends="load-tasks">
    <mkdir dir="${maven.gen.docs}/demo" />
    <dvsl basedir="${maven.pmd.reportsDirectory}"
          destdir="${maven.gen.docs}/demo"
          extension=".xml"
          includes="*.xml"
          style="dvsl/pmd-format.dvsl">
    </dvsl>
  </target>


</project>
