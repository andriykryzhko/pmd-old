<project name="pmd" default="compile" basedir="../">

<property name="lib" value="lib\"/>
<property name="src" value="src\"/>
<property name="classes" value="classes\"/>
<property name="build" value="build\"/>
<property name="rulesets" value="rulesets\"/>
<property name="test-data" value="test-data\"/>
<property name="regress" value="regress\"/>
<property name="reports" value="reports\"/>
<property name="version" value="1.04"/>
<property name="jnlp_staging_area" value="/home/tom/misc/importscrubberjnlp/"/>

<path id="classpath.path">
<pathelement location="${build}"/>
<fileset dir="${lib}">
<include name="*.jar"/>
</fileset>
</path>

<target name="delete">
    <delete dir="${build}"/>
    <delete file="${lib}\pmd.jar"/>
    <mkdir dir="${build}"/>
</target>

<target name="compile">
    <mkdir dir="${build}"/>
    <javac  deprecation="false"
            debug="true"
            optimize="false"
            srcdir="${src}:${regress}"
            destdir="${build}">
<classpath>
    <path refid="classpath.path"/>
</classpath>
    </javac>
</target>

<target name="copy">
    <mkdir dir="${lib}"/>
    <copy todir="${build}rulesets">
        <fileset dir="${rulesets}">
            <include name="*.xml"/>
            <include name="*.properties"/>
        </fileset>
    </copy>
    <copy todir="${build}">
        <fileset dir="${classes}">
            <include name="**/*.gif"/>
            <include name="**/*.jpg"/>
            <include name="**/*.properties"/>
        </fileset>
    </copy>
</target>

<target name="jar" depends="copy">
    <jar jarfile="${lib}\pmd-${version}.jar" basedir="${build}" manifest="etc/MANIFEST.MF"/>
</target>

<target name="pmd">
    <taskdef name="pmd" classname="net.sourceforge.pmd.ant.PMDTask"/>
    <pmd rulesetfiles="rulesets/favorites.xml">
        <formatter type="net.sourceforge.pmd.renderers.HTMLRenderer" toFile="foo.html"/>
        <fileset dir="/usr/local/java/src/java/lang/ref">
            <include name="**/*.java"/>
        </fileset>
    </pmd>
</target>

<target name="test" depends="compile">
    <junit printsummary="yes" haltonfailure="yes">
      <classpath>
        <pathelement location="${build}" />
        <pathelement location="${test-data}" />
        <pathelement location="${basedir}" />
      </classpath>
      <batchtest fork="no" todir="${build}">
        <fileset dir="${regress}">
          <include name="test/**/*Test.java" />
        </fileset>
      </batchtest>
  <formatter type="plain" />
    </junit>
</target>


<target name="jjtree">
    <jjtree target="etc/Java1.4-c.jjt" outputdirectory="src/net/sourceforge/pmd/ast" javacchome="/usr/local/javacc-3.0/"/>
    <javacc target="src/net/sourceforge/pmd/ast/Java1.4-c.jj" outputdirectory="src/net/sourceforge/pmd/ast" javacchome="/usr/local/javacc-3.0/"/>
    <delete file="src/net/sourceforge/pmd/ast/Java1.4-c.jj"/>
    <replace file="src/net/sourceforge/pmd/ast/JavaCharStream.java" token="throw new Error" value="throw new RuntimeException"/>
    <replace file="src/net/sourceforge/pmd/ast/JavaParser.java" token="throw new Error" value="throw new RuntimeException"/>
    <replace file="src/net/sourceforge/pmd/ast/JavaParser.java" token="(Error)" value="(RuntimeException)"/>
    <replace file="src/net/sourceforge/pmd/ast/JavaParserTokenManager.java" token="throw new Error" value="throw new RuntimeException"/>
    <replace file="src/net/sourceforge/pmd/ast/ParseException.java" token="throw new Error" value="throw new RuntimeException"/>
    <replace file="src/net/sourceforge/pmd/ast/TokenMgrError.java" token="extends Error" value="extends RuntimeException"/>
</target>

<target name="clean" depends="delete,compile"/>

<target name="dist" depends="clean,jar"/>

<target name="cpdjnlp" depends="dist">
    <signjar jar="${lib}/pmd-${version}.jar" alias="myself" keystore="${jnlp_staging_area}myKeyStore" storepass="password"/>
    <echo message="Uploading jar file"/>
    <exec executable="scp" os="Linux">
        <arg line=" /home/tom/data/pmd/pmd/lib/pmd-${version}.jar tomcopeland@pmd.sourceforge.net:/home/groups/p/pm/pmd/htdocs"/>
    </exec>
    <echo message="Uploading cpd.jnlp"/>
    <exec executable="scp" os="Linux">
        <arg line=" /home/tom/data/pmd/pmd/etc/cpd.jnlp tomcopeland@pmd.sourceforge.net:/home/groups/p/pm/pmd/htdocs"/>
    </exec>
</target>

<target name="cpd">
    <taskdef name="cpd" classname="net.sourceforge.pmd.cpd.CPDTask" />
    <cpd tileSize="100" codeLocation="/home/tom/tmp/ant/src/main/org/apache/tools/ant/filters/" outputFile="/home/tom/cpd.txt"/>
</target>

</project>




